name: Pre-Release Checklist

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.1.0)'
        required: true
        type: string

jobs:
  pre-release-checks:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION=${{ github.event.inputs.version }}
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 1.1.0)"
            exit 1
          fi
          echo "✅ Version format is valid: $VERSION"

      - name: Check CHANGELOG has version entry
        run: |
          VERSION=${{ github.event.inputs.version }}
          if grep -q "^## \[$VERSION\]" CHANGELOG.md; then
            echo "✅ Version [$VERSION] found in CHANGELOG.md"
          else
            echo "❌ Version [$VERSION] not found in CHANGELOG.md"
            exit 1
          fi

      - name: Check CHANGELOG has release date
        run: |
          VERSION=${{ github.event.inputs.version }}
          if grep -qE "^## \[$VERSION\] - [0-9]{4}-[0-9]{2}-[0-9]{2}" CHANGELOG.md; then
            DATE=$(grep "^## \[$VERSION\]" CHANGELOG.md | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}")
            echo "✅ Release date found: $DATE"
          else
            echo "⚠️  Warning: Release date not in YYYY-MM-DD format"
          fi

      - name: Check for empty sections
        run: |
          VERSION=${{ github.event.inputs.version }}
          
          # Extract version section
          SECTION=$(sed -n "/^## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '/^\[/,$d' | sed '$d')
          
          # Check that each subsection header has at least one bullet point entry
          EMPTY_SUBSECTIONS=0
          while read -r header; do
            # Find lines after the header until the next header or end of section
            CONTENT=$(echo "$SECTION" | awk "/^$header/{flag=1;next}/^###/{if(flag){exit}}flag" | grep "^- ")
            if [ -z "$CONTENT" ]; then
              echo "❌ Changelog subsection '$header' has no content entries"
              EMPTY_SUBSECTIONS=1
            fi
          done < <(echo "$SECTION" | grep "^###" | uniq)
          if [ "$EMPTY_SUBSECTIONS" -eq 1 ]; then
            exit 1
          else
            echo "✅ Changelog has content with entries in all subsections"
          fi

      - name: Verify no duplicate version tags
        run: |
          VERSION=${{ github.event.inputs.version }}
          COUNT=$(grep "^## \[$VERSION\]" CHANGELOG.md | wc -l)
          if [ "$COUNT" -eq 1 ]; then
            echo "✅ Version [$VERSION] appears exactly once"
          else
            echo "❌ Version [$VERSION] appears $COUNT times (should be 1)"
            exit 1
          fi

      - name: Summary
        run: |
          echo "✅ All pre-release checks passed!"
          echo ""
          echo "Ready to run: git tag -a v${{ github.event.inputs.version }} -m 'Release v${{ github.event.inputs.version }}'"
          echo "Then: git push origin v${{ github.event.inputs.version }}"
